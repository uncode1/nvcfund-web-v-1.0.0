<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - NVC Fund Holdings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-brand {
            font-weight: bold;
            color: #2c3e50 !important;
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            font-weight: 600;
        }
        .metric-card {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .rail-card {
            border-left: 4px solid #667eea;
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }
        .capacity-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        .capacity-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        .routing-form {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-institutional {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border: none;
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 600;
        }
        .btn-institutional:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            color: white;
        }
        .currency-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-university"></i> NVC Fund Holdings
            </a>
            <span class="navbar-text">
                <strong>Institutional Transaction Routing</strong>
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header with Key Metrics -->
        <div class="row mb-4">
            <div class="col-12">
                <h1><i class="fas fa-route"></i> Institutional Payment Infrastructure</h1>
                <p class="lead">$245 Billion Daily Capacity • Central Bank Direct Access • Real-time Settlement</p>
            </div>
        </div>

        <!-- Capacity Overview Cards -->
        <div class="row mb-4">
            {% if capacity_summary.status == 'success' %}
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">{{ capacity_summary.total_active_rails }}</div>
                    <div>Active Payment Rails</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">{{ capacity_summary.total_currencies }}</div>
                    <div>Supported Currencies</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">$245B</div>
                    <div>Combined Daily Capacity</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">$50B</div>
                    <div>Max Single Transaction</div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="row">
            <!-- Transaction Routing Form -->
            <div class="col-lg-6">
                <div class="routing-form">
                    <h4><i class="fas fa-calculator"></i> Route Institutional Transaction</h4>
                    <form id="routingForm">
                        <div class="mb-3">
                            <label for="amount" class="form-label">Transaction Amount (USD)</label>
                            <input type="text" class="form-control" id="amount" placeholder="25,000,000,000" required>
                            <div class="form-text">Minimum: $1,000,000 • Institutional Scale: $1B+</div>
                        </div>

                        <div class="mb-3">
                            <label for="currency" class="form-label">Currency</label>
                            <select class="form-select" id="currency" required>
                                <option value="NVCT">NVCT - NVC Token (Blockchain Bridge)</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                                <option value="CHF">CHF - Swiss Franc</option>
                                <option value="CAD">CAD - Canadian Dollar</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                                <option value="CNY">CNY - Chinese Yuan</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="transactionClass" class="form-label">Transaction Class</label>
                            <select class="form-select" id="transactionClass" required>
                                <option value="central_bank">Central Bank Operations</option>
                                <option value="sovereign_wealth">Sovereign Wealth Fund</option>
                                <option value="commercial_bank">Commercial Bank</option>
                                <option value="investment_bank">Investment Bank</option>
                                <option value="hedge_fund">Hedge Fund</option>
                                <option value="pension_fund">Pension Fund</option>
                                <option value="corporate_treasury">Corporate Treasury</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="priority" class="form-label">Routing Priority</label>
                            <select class="form-select" id="priority">
                                <option value="balance_optimized">Balance Optimized</option>
                                <option value="speed_optimized">Speed Optimized</option>
                                <option value="cost_optimized">Cost Optimized</option>
                                <option value="reliability_optimized">Reliability Optimized</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-institutional">
                            <i class="fas fa-route"></i> Calculate Optimal Route
                        </button>
                    </form>

                    <!-- Routing Result -->
                    <div id="routingResult" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-check-circle"></i> Routing Decision
                            </div>
                            <div class="card-body" id="routingDetails">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Rails Overview -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-network-wired"></i> Payment Rails Status
                    </div>
                    <div class="card-body">
                        {% if capacity_summary.status == 'success' %}
                        {% for currency, details in capacity_summary.capacity_summary.items() %}
                        <div class="currency-section mb-4">
                            <h6>
                                <span class="currency-badge">{{ currency }}</span>
                                {{ details.active_rails }} Active Rails
                            </h6>
                            
                            {% for rail in details.rail_details %}
                            <div class="rail-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="status-indicator status-active"></span>
                                        <strong>{{ rail.name }}</strong>
                                        <div class="small text-muted">{{ rail.type.replace('_', ' ').title() }}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="small">
                                            Daily: {% if rail.daily_limit == 'unlimited' %}Unlimited{% else %}<strong>${{ "{:,.0f}".format(rail.daily_limit/1000000000) }}B</strong>{% endif %}
                                        </div>
                                        <div class="small text-muted">
                                            Max: {% if rail.max_transaction == 'unlimited' %}Unlimited{% else %}<strong>${{ "{:,.0f}".format(rail.max_transaction/1000000000) }}B</strong>{% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="capacity-bar mt-2">
                                    <div class="capacity-fill" style="width: 5.2%"></div>
                                </div>
                                <div class="small text-muted mt-1">Utilization: 5.2% of capacity</div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Unable to load payment rail status
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Access Links -->
                <div class="card mt-3">
                    <div class="card-header">
                        <i class="fas fa-external-link-alt"></i> Quick Access
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/institutional-pool/dashboard" class="btn btn-outline-primary">
                                <i class="fas fa-chart-line"></i> Institutional Dashboard
                            </a>
                            <a href="#" class="btn btn-outline-secondary" onclick="simulateRouting()">
                                <i class="fas fa-flask"></i> Simulate Multiple Routes
                            </a>
                            <a href="#" class="btn btn-outline-info" onclick="viewCapacityDetails()">
                                <i class="fas fa-info-circle"></i> Detailed Capacity Analysis
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Format number with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Remove commas and get numeric value
        function unformatNumber(str) {
            return str.replace(/,/g, '');
        }
        
        // Handle amount input formatting
        document.getElementById('amount').addEventListener('input', function(e) {
            let value = unformatNumber(e.target.value);
            if (value && !isNaN(value)) {
                e.target.value = formatNumber(value);
                
                // Show billions notation for large numbers
                const billions = (parseFloat(value) / 1000000000).toFixed(1);
                if (parseFloat(value) >= 1000000000) {
                    e.target.title = `$${billions}B`;
                }
            }
        });

        document.getElementById('routingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rawAmount = unformatNumber(document.getElementById('amount').value);
            
            const formData = {
                amount: rawAmount,
                currency: document.getElementById('currency').value,
                transaction_class: document.getElementById('transactionClass').value,
                priority: document.getElementById('priority').value
            };

            try {
                const response = await fetch('/institutional-routing/route-transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    displayRoutingResult(result);
                } else {
                    alert('Routing failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        function displayRoutingResult(result) {
            const resultDiv = document.getElementById('routingResult');
            const detailsDiv = document.getElementById('routingDetails');
            
            const fees = result.transaction_fees;
            const rail = result.selected_rail;
            
            detailsDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-route"></i> Selected Rail</h6>
                        <p><strong>${rail.name}</strong><br>
                        <span class="badge bg-primary">${rail.type.replace('_', ' ')}</span></p>
                        
                        <h6><i class="fas fa-clock"></i> Settlement</h6>
                        <p>${result.estimated_settlement_time}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-dollar-sign"></i> Transaction Costs</h6>
                        <p>Total Fee: <strong>$${fees.total_fee.toLocaleString()}</strong><br>
                        Fee Rate: <strong>${fees.fee_percentage}%</strong></p>
                        
                        <h6><i class="fas fa-shield-alt"></i> Risk Level</h6>
                        <p><span class="badge bg-${result.risk_assessment.risk_level === 'LOW' ? 'success' : result.risk_assessment.risk_level === 'MEDIUM' ? 'warning' : 'danger'}">${result.risk_assessment.risk_level}</span></p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6><i class="fas fa-lightbulb"></i> Routing Analysis</h6>
                    <p class="small">${result.routing_analysis.routing_reason}</p>
                </div>
            `;
            
            resultDiv.style.display = 'block';
        }

        function simulateRouting() {
            alert('Simulation feature would compare all routing priorities for the current transaction parameters.');
        }

        function viewCapacityDetails() {
            alert('Detailed capacity analysis would show real-time utilization across all payment rails.');
        }

        // Format large numbers in amount input
        document.getElementById('amount').addEventListener('input', function(e) {
            const value = e.target.value;
            if (value >= 1000000000) {
                const billions = (value / 1000000000).toFixed(1);
                e.target.title = `$${billions}B`;
            }
        });
    </script>
</body>
</html>